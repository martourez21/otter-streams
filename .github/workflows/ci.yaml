name: Java CI/CD for Multi-Module Maven Project

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11', '17' ]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Clean previous artifacts
        run: mvn clean

      - name: Build all modules
        run: mvn -B verify -DskipTests

      - name: Run tests
        run: mvn -B test
        continue-on-error: true  # remove once tests are stable

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-jdk-${{ matrix.java }}
          path: |
            **/target/surefire-reports/
            **/target/site/

      - name: Package all modules
        run: mvn -B package -DskipTests

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/target/*.jar
            !**/target/original-*.jar
            !**/target/*-tests.jar
          retention-days: 7

  generate-docs:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Generate Javadocs for all modules
        run: mvn javadoc:javadoc

      - name: Upload Javadocs
        uses: actions/upload-artifact@v4
        with:
          name: javadocs
          path: target/site/apidocs/

  deploy-docs:
    runs-on: ubuntu-latest
    needs: generate-docs
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Download Javadocs
        uses: actions/download-artifact@v4
        with:
          name: javadocs
          path: .

      - name: Push to gh-pages branch
        run: |
          if git ls-remote --exit-code --heads origin gh-pages; then
            git checkout --orphan temp-gh-pages
            git rm -rf .
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi
          git add .
          git commit -m "Deploy Javadocs for ${{ github.sha }}" || echo "No changes to commit"
          if git ls-remote --exit-code --heads origin gh-pages; then
            git push --force origin HEAD:gh-pages
          else
            git push origin HEAD:gh-pages
          fi

  publish-modules:
    runs-on: ubuntu-latest
    needs: [build, generate-docs]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Deploy each module individually
        run: |
          for module in ml-inference-core \
                        otter-stream-onnx \
                        otter-stream-tensorflow \
                        otter-stream-pytorch \
                        otter-stream-xgboost \
                        otter-stream-pmml \
                        otter-stream-remote \
                        otter-stream-examples; do
            echo "Deploying $module..."
            mvn -B deploy -pl $module -am -DskipTests
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    runs-on: ubuntu-latest
    needs: [build, generate-docs]
    if: github.event_name == 'release'
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Maven version for all modules
        run: mvn versions:set -DnewVersion=${{ steps.version.outputs.VERSION }} -DgenerateBackupPoms=false

      - name: Deploy all modules for release
        run: |
          for module in ml-inference-core \
                        otter-stream-onnx \
                        otter-stream-tensorflow \
                        otter-stream-pytorch \
                        otter-stream-xgboost \
                        otter-stream-pmml \
                        otter-stream-remote \
                        otter-stream-examples; do
            echo "Deploying $module release..."
            mvn -B deploy -pl $module -am -DskipTests
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
